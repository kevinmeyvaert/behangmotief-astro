---
import Image from 'astro/components/Image.astro';
import { decode } from 'blurhash';
import sharp from 'sharp';

interface Props {
  src: string;
  alt: string;
  width: number;
  height: number;
  blurhash: string;
  class?: string;
  loading?: 'lazy' | 'eager';
}

const {
  src,
  alt,
  width,
  height,
  blurhash = 'LQ5GD5MuZ}e-yGRMaJadRMo#W@ad',
  class: className = '',
  loading = 'lazy',
} = Astro.props;

// Generate blurhash preview
const pixels = decode(blurhash, 32, 32);
const buffer = Buffer.from(pixels);

// Convert to PNG and get base64
const sharpImage = sharp(buffer, {
  raw: {
    width: 32,
    height: 32,
    channels: 4,
  },
});

const base64Image = await sharpImage
  .png()
  .toBuffer()
  .then((buffer) => `data:image/png;base64,${buffer.toString('base64')}`);
---

<div class="relative">
  <div
    class="absolute inset-0 bg-center bg-cover bg-no-repeat"
    style={`background-image: url("${base64Image}");`}
  >
  </div>
  <Image
    src={src}
    alt={alt}
    width={width}
    height={height}
    class={`relative ${className}`}
    loading={loading}
  />
</div>
